import os
import sys
from collections import Counter
from Bio import AlignIO, SeqIO
from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord

# Add the parent directory to sys.path to import config.py
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
import config

def generate_consensus(alignment_filename, threshold=0.5):
    """
    Reads an MSA file and generates a consensus sequence.
    If a character in a column appears with a frequency >= threshold, it is kept.
    Otherwise, an ambiguous character (e.g., 'X' or 'N') is assigned.
    """
    input_path = os.path.join(config.ALIGNMENTS_DIR, alignment_filename)
    output_path = os.path.join(config.ALIGNMENTS_DIR, "hemoglobin_consensus.fasta")
    
    if not os.path.exists(input_path):
        print(f"Error: Alignment file {input_path} not found. Run msa.py first.")
        return None

    print(f"Generating consensus sequence from {alignment_filename}...")
    
    try:
        # Load the alignment generated by MUSCLE
        alignment = AlignIO.read(input_path, "fasta")
        alignment_len = alignment.get_alignment_length()
        num_seqs = len(alignment)
        
        consensus_seq_list = []
        
        # Iterate over every column in the alignment matrix
        for i in range(alignment_len):
            # Extract the entire column across all sequences
            column = alignment[:, i]
            
            # Count the occurrences of each character in the column
            counts = Counter(column)
            most_common_char, most_common_count = counts.most_common(1)[0]
            
            # Calculate the frequency of the most common character
            frequency = most_common_count / num_seqs
            
            # If the most common character meets the threshold and is not a gap, keep it
            if frequency >= threshold and most_common_char != '-':
                consensus_seq_list.append(most_common_char)
            elif most_common_char == '-':
                # If the majority is a gap, we omit it from the consensus
                pass
            else:
                # If there is no clear consensus, mark as 'X' (unknown amino acid)
                consensus_seq_list.append('X')
                
        # Join the list into a single string
        consensus_string = "".join(consensus_seq_list)
        
        
        
        # Create a new SeqRecord for the consensus
        consensus_record = SeqRecord(
            Seq(consensus_string),
            id="Consensus_Sequence",
            description=f"Consensus generated with {threshold*100}% threshold"
        )
        
        # Save the consensus sequence
        SeqIO.write([consensus_record], output_path, "fasta")
        
        print("\n--- Consensus Generation Summary ---")
        print(f"Original Alignment Length: {alignment_len}")
        print(f"Consensus Length (Gaps Removed): {len(consensus_string)}")
        print(f"Preview: {consensus_string[:60]}...")
        print(f"Saved to: {output_path}")
        
        return consensus_record
        
    except Exception as e:
        print(f"An error occurred during consensus generation: {e}")
        return None

if __name__ == "__main__":
    generate_consensus("hemoglobin_msa.fasta", threshold=0.6)